---
title: "Demography Koyama's adapatation"
author: "SC"
date: "`r Sys.time()`"
output: 
    bookdown::html_document2:
        code_folding: show
        section_numbers: true
        toc: true
        toc_depth: 3
        toc_float: true
---

```{r}

knitr::opts_chunk$set(warning=FALSE,message=FALSE,cache=FALSE,collapse=TRUE,fig.show="hold",results="hide")
```
# Koyama's Original Model

Koyama's original model is based on the following equation:

$P_h/S_h = P_j/S_j$

Where $P_h$ and $P_j$ are the population sizes of Haji and Jomon periods, and $S_h$ and $S_j$ are the number of sites.
The Equation holds as long as the following assumptions are met:

1) Both periods have the same duration in time
2) Sites of both period contribute equally to the total population size
3) Site number does not change abruptly during each period.

If this is the case then it is possible to estimate the Jomon population size by the following equation:

$P_j = S_h/P_h * S_j$

The example below is the one used for the Middle Jomon (originally J3) period:

```{r}
Ph_r_k84=9443300
Sh=5549
Sj=3977 #for middle Jomon
Pj = Ph_r_k84/Sh * Sj

```

The three assumptions are however potential problematic. For assumption (2) Koyama suggest a weighting. This is because the Jomon sites are exepcted to have smaller size, and given the same number of sites and duration there should be smaller population size. Koyama explores two values 1/7 and 1/5, and settles for the former so that the revised equation becomes:


$P_j = S_h/P_h * S_j * C_j$

Where $C_j$ is the correction factor, equivalent in the case of middle Jomon to 1/7.

# Understanding Koyama's inconsistencies:

From his own words:

> Kanto yielded a total of $3,977$ Jomon 3 sites and 5,549 Haji sites. The eighth century population of this area is calculated at 943,300. Therefbre, the value of a Haji site is 170 (VH=943,OOO÷5,549). The ratio of Jomon 3 to Haji site is .71 $(T_{j3}÷T_h==3,977÷5,549)$. If we assume an equal value for Jomon and Haji sites, the population of Jomon 3 in Kanto becomes $676,068 (.71 \time 943,300)$. Since a Jomon 3 site is actually valued at 1/5 or 1/7 of a Haji site, the maximum population, when $1/5$ is used as the constant, is $135,214$.

Note: Koyama use $T_x$ instead of $S_x$ we will stick to $S_x$ for the number of Site ; I also use $R_x$ as the ratio Population per sites ($\frac{P_x}{S_x}$)


If we take back his numbers. `ksn` store his table with the number of settlements counted for each prefectures (is table 2 from his paper 1978) .  `groupedsite` is the table 3 where site are grouped dby region, we can alread see there don't match if we manually add them, probably because of typo

```{r}
ksn=read.csv("data/koyama78sitenumber.csv")
groupedsite=read.csv("data/koyama78groupedsn.csv",row.names=1)
Sy_r_k=groupedsite$Yayoi.Total # number of site per regioi
names(Sy_r_k)=rownames(groupedsite) 
Sy_p=ksn$Yayoi.Total ##number of site per prefecture
Sy_r_kb=tapply(Sy_p,ksn$Region,sum,na.rm=T) #site per region bis
n=names(Sy_r_kb) 
Sy_r_k[n]-Sy_r_kb[n]
```

Let's recompute the Jomon population for all regions using Kanto's medevial population and site counts as reference. Koyama's 

```{r}
Sh_p_k=ksn$Haji.Total
Sh_kanto=sum(Sh_p_k[ ksn$Region == "Kanto"])
Sj=sum(ksn$J.3[ ksn$Region == "Kanto"],na.rm=T)
regmatches=read.csv("data/prefecture_region_match.csv")
trad=readRDS("../encounter_data/traductionRegion.RDS")

#number of site during yayoi:
Sy=Sy_r_kb[n]
pop_yayoi=Sy*(943000/Sh_kanto)*1/3
pop_yayoi=rbind(pop_yayoi,Sy*(943300/Sh_kanto)*1/3)
rownames(pop_yayoi)=c("943,000","943,300")
barplot(pop_yayoi,las=3,beside=T,legend=T)

```

Compare to what is written in 1984 paper where is supposedly used the same method but "corrected" some values:

```{r}
kps=read.csv("data/koyama_popestimate_1984.csv")

trad=gsub("地方","",trad)
regions=sapply(kps[-nrow(kps),1],function(i,trad)names(trad)[trad==i],trad=trad)
regions["近畿"]="Kinki"
kps$reg_en =NA
kps$reg_en[1:9] =unlist(regions)
Py_r_k84=kps[,"弥生"]
names(Py_r_k84)=kps$reg_en
pop_yayoi=rbind(pop_yayoi,K84=kpsy[colnames(pop_yayoi)])

barplot(pop_yayoi,las=3,beside=T,legend=T,main="pop estimate, fixed ratio, 3 versions")
```

## Region dependend Ratio:

Still using Koyama sites counts but refining to use a ratio region-depent:

```{r,out.width="45%"}
Ph_r_k84=kps[,"土師"]
names(Ph_r_k84)=kps$reg_en
Sh_p_kb=ksn$Haji.Total
Sh_r_kb=tapply(Sh_p_kb,ksn$Region,sum,na.rm=T)
Rh_r_kb=(Ph_r_k84[names(Sh_r_kb)]/Sh_r_kb) #Ratio pop per region using Koyama's site count
Rh_r_kb[is.infinite(Rh_r_kb)]=Rh_r_kb["Kanto"] #when unkown use kanto's ratio
Py_r_kb=Sy_r_kb*Rh_r_kb*1/3
pop_yayoi=rbind(pop_yayoi,"Varying Ratio"=Py_r_kb)
barplot(pop_yayoi,beside=T,legend=T)
pop_yayoi=pop_yayoi[,-1]
col=adjustcolor(palette.colors(nrow(pop_yayoi),"Set 2"),.8)

barplot(pop_yayoi,beside=T,log="y",col=col,las=3)
legend("topleft",legend=rownames(pop_yayoi),fill=col)
```

This yield  very wrong result cause the site counts are way off. We need to use updated count numbers.

Looking at the prefecture level:


```{r}
names(Sh_p_kb)=ksn$Region #we will use the regio to get back the ratio
Sy_p_k=ksn$Yayoi.Total
names(Sy_p_k)=ksn$Prefecture

Rh_p_k=Rh_r_kb[ksn$Region]
Rh_p_k[is.na(Rh_p_k)]=Rh_r_kb["Kanto"] ##should be used now as this is done before
Py_p_k=Sy_p_k * Rh_p_k * 1/3
names(Py_p_k)=ksn$Prefecture
barplot(Py_p_k,las=3,log="y",main="pop estimate per pref, Koyama counts")
```

Grouping these prefecture by Rice Area:

```{r}
areas=read.csv("data/prefecture_region_match.csv")
a=areas$Area #handy dict
names(a)=areas$Prefecture
ksn=merge(areas,ksn,by="Prefecture") # add area to Koyama original table
Sy_a_k=tapply(ksn$Yayoi.Total,ksn$Area,sum,na.rm=T) # Site count by area using koyama counts
```

## Using new settlement count

Now using new settlements counts ; we first compare the sites counts ; at the Prefecture level:

```{r,fig.lab="Site count at prefetur level"}
newcounts =read.csv("data/siteperprefperiod_cleaned.csv")
trans=read.csv("data/prefectures_translations.csv")
newcounts=merge(newcounts,trans,by=1)
Sy_p_n=newcounts$弥生 #site count per prefercture, new counts
names(Sy_p_n)=newcounts$Translation
barplot(rbind(updated=Sy_p_n,Koyama=Sy_p_k[names(Sy_p_n)]),col=adjustcolor(1:2,.7),legend=T,beside=T,las=3,main="Number of settlement per prefecture for Yayoi Period")
d=Sy_p_n-Sy_p_k[names(Sy_p_n)]
d[is.na(d)]=Sy_p_n[names(d[is.na(d)])]
barplot(d,col=ifelse(d>0,1,2),las=3,)
```

### Site per region and population estimate:

Compute $S_{h,r}$, for each  region $r$ as the total number of site during $h$ Haji period using this new dataset and $S_{y,r}$  the same for Yayoi period

```{r}
Sh_p_n=newcounts$古墳+newcounts$古代
Sh_r_n=tapply(Sh_p_n,newcounts$Region.alt,sum)

```

Does the count really correlate with the popualtion estimates?

```{r}
par(xpd=NA)
plot(Sh_r_n,Ph_r_k84[names(Sh_r_n)],log="y",pch=21,bg=adjustcolor(2,.5),ylab="Population Estimate",xlab="Site count")
text(Sh_r_n,Ph_r_k84[names(Sh_r_n)],labels = names(Sh_r_n),pos=3)
```


### Ratio Population/Site

Compute the ratio $R_{h,r}=\frac{P_{h,r}}{S_{h,r}}$, $S_{h,r}$ the number of site for region r during haji period, $P_{h,r}$ the population estimate during haji period for the region $r$.

```{r}

Rh_r_n=Ph_r_k84/Sh_r_n[names(Ph_r_k84)] #Ph_r_k84 is the population estimate by regio, which is the only one we have
par(mar=c(6,6,4,1))
barplot(Rh_r_n,main="Region-depend pop/site ratio counts",ylab=expression(frac(P[haiji],T[haiji])),las=3,col=adjustcolor("blue",.4))
```

Estimate the population per prefecture for the Yayoi Period using the new site count and the ratio computed before

```{r}
Sy_p_n=newcounts$弥生
names(Sy_p_n)=newcounts$Translation
Py_p_n=Sy_p_n * Rh_r_n[ newcounts$Region.alt] * 1/3
names(Py_p_n)=newcounts$Translation
barplot(Py_p_n,las=3,main="population estimate by prefecture using new counts")
```

We can now group these estimates by region and rice area:

```{r,out.width="45%",fig,show="hold"}
Py_a_n=tapply(Py_p_n,a[names(Py_p_n)],sum)
Py_r_n=tapply(Py_p_n,newcounts$Region.alt,sum)
Ty_r_n=tapply(Sy_p_n,newcounts$Region.alt,sum)
barplot(Py_r_n,col=adjustcolor("red",.3),main="Population Estimates by Region",las=3)
barplot(Py_a_n[-1],col=adjustcolor("blue",.3),main="Population Estimates by Rice Area",las=3)
```

If we compare to the previous estimation at the region level:
```{r}
col=adjustcolor(palette.colors(nrow(pop_yayoi),"Set 2"),.8)
pop_yayoi=rbind(pop_yayoi,"New Counts,Varying Ratio"=Py_r_n[colnames(pop_yayoi)])
barplot(pop_yayoi,beside=T,log="y",col=col,main="Population Estimates by Regions",las=3)
legend("topleft",legend=rownames(pop_yayoi),fill=col)
```

How varying the ratio per region compare to his fixed ratio from Kanto? the obvious problem is that Koyama's site count for Kanto is: `Sh` whereas the new count are `Sh_r_n["Kanto"]`

```{r}
Sy_r_n=tapply(newcounts[,"弥生"],newcounts$Region.alt,sum)
pop_yayoi=rbind(pop_yayoi,"New Counts,Fixed Ratio"=Rh_r_n["Kanto"]*Sy_r_n[colnames(pop_yayoi)]*1/3)
col=adjustcolor(palette.colors(nrow(pop_yayoi),"Set 2"),.8)
barplot(pop_yayoi[c(1,3,4,5,6),],beside=T,col=col,main="Population Estimates by Regions",las=3)
legend("topleft",legend=rownames(pop_yayoi)[c(1,3,4,5,6)],fill=col[c(1,3,4,5,6)])

```

Comparing site counts:


```{r}
Sy
```

### Fujio Sites counts:

Compare the raw Fujio's count per Area with these one:

```{r}
fujio=c(1639,495,2570,3973,3547,1183,319,116)
names(fujio)=paste0("Area",1:8)
newsitecount=tapply(newcounts$弥生,a[newcounts$Translation],sum)
newsitecount=newsitecount[names(fujio)]

barplot(rbind(new=newsitecount,fujio),beside=T,legend=T)
par(xpd=NA)
plot(newsitecount,fujio,pch=21,bg=adjustcolor(2,.6))
text(newsitecount,fujio,names(fujio),pos=3)
```

Compare to after yayoi:
```{r}
 barplot(rbind(Yayoi=Py_r_n,H=Ph_r_k84[names(Py_r_n)]),beside=T,log="y")
 barplot(Ph_r_k84[names(Py_r_n)]/Py_r_n)

```

## Correct by period:


```{r}

correct_perdiod=read.csv("data/yayoiduration.csv")
Dyh=1000/abs(sapply(gsub("BC","-",correct_perdiod[3:9]),function(i)eval(parse(text=i))))
names(Dyh)=colnames(correct_perdiod)[3:9]


```


Then we can normalise our previous calculation with this $D_{yh}$ per region

```{r}

Py_p_nd=Sy_p_n * Rh_r_n[ newcounts$Region.alt] * 1/3 *  Dyh[newcounts$Region.time]
names(Py_p_nd)=newcounts$Translation

Py_a_nd=tapply(Py_p_nd,a[names(Sy_p_n)],sum)
Py_r_nd=tapply(Py_p_nd,newcounts$Region.alt,sum)


pop_yayoi=rbind(pop_yayoi,"New count, time adjusted"=Py_r_nd[colnames(pop_yayoi)])
pop_yayoi=pop_yayoi[,-1]
col=adjustcolor(palette.colors(nrow(pop_yayoi),"Set 2"),.8)
barplot(pop_yayoi,beside=T,log="y",col=col,las=3,legend=T,args.legend = list(x="topleft",cex=.6,ncol=2))

```


Selecting a subset of the models:
```{r}
selected=pop_yayoi[c(3,6,5,7),]
col=adjustcolor(palette.colors(nrow(selected),"Set 2"),.8)
barplot(selected,beside=T,col=col,las=3,legend=T,args.legend = list(x="topleft",cex=.6,ncol=2))
```


```{r}

main.col <- c(rgb(51,34,136,maxColorValue=255),rgb(136,204,238,maxColorValue = 255),rgb(68,170,153,maxColorValue = 255),rgb(17,119,51,maxColorValue = 255),rgb(153,153,51,maxColorValue = 255),rgb(221,204,119,maxColorValue = 255),rgb(204,102,119,maxColorValue = 255),rgb(136,34,85,maxColorValue = 255))

cols=RColorBrewer::brewer.pal(8,"Set2")
barplot(Py_r_nd,col=adjustcolor("red",.3),main="Population Estimates by Region",las=3)
barplot(Py_a_nd[-1],col=cols,main="Population Estimates by Rice Area",las=3)

s=newcounts
s$Prefecture=newcounts$Translation
s=merge(s,areas,by="Prefecture")
s=tapply(s$Area.x,s$Area.y,sum)
barplot(Py_a_nd[-1]/s[names(Py_a_nd[-1])],col=cols,main="Population Estimates by Rice Area/aea size",las=3)

```

The Equation is thus:

$P_{yayoi,a}=\displaystyle\sum_{x \in a}\left({\frac{P_{haji,r_x}}{S_{haji,r_x}} \times S_{yayoi,x} \times C_{yayoi,x} \times \frac{D_{haji,r'_x}}{D_{yayoi,r'_x}}}\right)$

where $r_x$ an $r'_x$  are broader region that include x ,for which information is available (on population estimate or length in year of the yayoi period)

